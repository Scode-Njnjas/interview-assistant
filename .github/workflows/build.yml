name: Build Packages

# Reusable workflow — called by release.yml
on:
  workflow_call:
    inputs:
      publish:
        description: "Publish to GitHub Releases (true for release builds)"
        required: false
        type: boolean
        default: false
    secrets:
      GH_TOKEN:
        required: false
      # macOS signing (optional — builds are unsigned without these)
      CSC_LINK:
        required: false
      CSC_KEY_PASSWORD:
        required: false
      APPLE_API_KEY_ID:
        required: false
      APPLE_API_KEY_ISSUER:
        required: false
      APPLE_API_KEY_BASE64:
        required: false
      # Windows signing (optional)
      WIN_CSC_LINK:
        required: false
      WIN_CSC_KEY_PASSWORD:
        required: false

env:
  NODE_VERSION: "20"
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  build:
    name: Package (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native arm64 runner — do NOT cross-compile arm64 on x64
          - name: macOS-arm64
            os: macos-14
            build_cmd: npx electron-builder build --mac --arm64
          - name: macOS-x64
            os: macos-13
            build_cmd: npx electron-builder build --mac --x64
          - name: Windows
            os: windows-latest
            build_cmd: npx electron-builder build --win
          - name: Linux
            os: ubuntu-22.04
            build_cmd: npx electron-builder build --linux

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      # ── Electron binary cache ──
      - name: Cache Electron binaries
        uses: actions/cache@v4
        with:
          path: ${{ env.ELECTRON_CACHE }}
          key: electron-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('package-lock.json') }}
          restore-keys: electron-${{ runner.os }}-${{ runner.arch }}-

      # ── electron-builder tools cache ──
      - name: Cache electron-builder tools
        uses: actions/cache@v4
        with:
          path: ${{ env.ELECTRON_BUILDER_CACHE }}
          key: eb-tools-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: eb-tools-${{ runner.os }}-

      # ── Linux system dependencies ──
      - name: Install Linux build dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxkbfile-dev libsecret-1-dev libudev-dev libxtst-dev

      - name: Install dependencies
        run: npm ci

      # ── Build frontend + electron backend ──
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      # ── macOS code signing setup ──
      - name: Import macOS signing certificate
        if: runner.os == 'macOS' && env.CSC_LINK != ''
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
        run: echo "macOS signing certificate imported"

      # ── Apple notarization API key ──
      - name: Setup Apple API Key
        if: runner.os == 'macOS' && env.APPLE_API_KEY_BASE64 != ''
        env:
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          mkdir -p ~/.private_keys
          echo "$APPLE_API_KEY_BASE64" | base64 --decode > ~/.private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

      # ── Package the app ──
      - name: Package electron app
        run: ${{ matrix.build_cmd }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
          # macOS signing
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_KEY_ISSUER: ${{ secrets.APPLE_API_KEY_ISSUER }}
          # Windows signing
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      # ── Upload artifacts ──
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-build
          path: |
            release/*.dmg
            release/*.zip
            release/*.exe
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/*.yml
            release/*.yaml
          retention-days: 7
          if-no-files-found: warn
